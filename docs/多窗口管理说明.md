# 多窗口管理系统

## 概述

项目实现了完整的多窗口管理系统，支持主窗口、设置窗口和插件管理窗口的创建、管理和切换。

## 架构设计

### 核心组件

```
src/main/
├── index.ts                    # 主进程入口
├── windows/
│   ├── windowManager.ts        # 窗口管理器（核心）
│   ├── mainWindow.ts          # 主窗口管理
│   ├── settingsWindow.ts      # 设置窗口管理
│   └── pluginWindow.ts        # 插件管理窗口
└── handlers/
    └── windowHandlers.ts      # IPC 处理器
```

### 窗口类型

```typescript
type WindowType = 'main' | 'settings' | 'plugin';
```

- **main**: 主搜索窗口
- **settings**: 设置窗口
- **plugin**: 插件管理窗口

## 功能特性

### 1. 窗口管理器 (windowManager)

提供统一的窗口管理接口：

```typescript
class WindowManager {
  // 获取或创建窗口
  getOrCreateWindow(config: WindowConfig): BrowserWindow
  
  // 获取指定窗口
  getWindow(type: WindowType): BrowserWindow | undefined
  
  // 显示窗口
  showWindow(type: WindowType): void
  
  // 隐藏窗口
  hideWindow(type: WindowType): void
  
  // 切换窗口显示状态
  toggleWindow(type: WindowType): void
  
  // 关闭窗口
  closeWindow(type: WindowType): void
  
  // 关闭所有窗口
  closeAllWindows(): void
  
  // 获取所有窗口
  getAllWindows(): BrowserWindow[]
  
  // 获取活动窗口
  getActiveWindow(): BrowserWindow | undefined
}
```

### 2. 窗口配置

每个窗口都有独立的配置：

```typescript
interface WindowConfig {
  type: WindowType;
  url: string;
  width: number;
  height: number;
  minWidth?: number;
  minHeight?: number;
  maximizable?: boolean;
  minimizable?: boolean;
  resizable?: boolean;
}
```

#### 主窗口配置
- 尺寸: 700x80（初始仅输入框）
- 最小尺寸: 500x80
- 可调整大小，不可最大化

#### 设置窗口配置
- 尺寸: 1000x700
- 最小尺寸: 800x600

#### 插件管理窗口配置
- 尺寸: 900x700
- 最小尺寸: 700x500

### 3. 窗口生命周期

```
创建窗口 → 加载内容 → 显示 → 交互 → 关闭
   ↓                                    ↑
    ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ← ←
```

## 使用方法

### 主窗口

```typescript
import { getMainWindow, showMainWindow, hideMainWindow, toggleMainWindow } from './windows/mainWindow';

// 创建或获取主窗口
const window = getMainWindow();

// 显示主窗口
showMainWindow();

// 隐藏主窗口
hideMainWindow();

// 切换主窗口显示状态
toggleMainWindow();
```

### 设置窗口

```typescript
import { openSettingsWindow, closeSettingsWindow } from './windows/settingsWindow';

// 打开设置窗口
openSettingsWindow();

// 关闭设置窗口
closeSettingsWindow();
```

### 插件管理窗口

```typescript
import { openPluginWindow, closePluginWindow } from './windows/pluginWindow';

// 打开插件管理窗口
openPluginWindow();

// 关闭插件管理窗口
closePluginWindow();
```

## IPC 通信

### 从渲染进程调用

```typescript
// 显示/隐藏窗口
await window.electron.invoke('window-show', 'settings');
await window.electron.invoke('window-hide', 'settings');
await window.electron.invoke('window-toggle', 'settings');

// 关闭窗口
await window.electron.invoke('window-close', 'settings');

// 调整主窗口大小
await window.electron.windowResize(800, 500);
```

## 快捷键

### 全局快捷键（当前实现）

- 所有平台：`Shift + Space` 显示主窗口

### 注册位置（示例）

```typescript
// src/main/index.ts
app.on('ready', () => {
  const shortcut = 'Shift+Space';
  const ret = globalShortcut.register(shortcut, () => {
    // 显示主窗口（不切换，不隐藏）
    showMainWindow();
  });
});
```

## 开发模式 vs 生产模式

### 开发模式

窗口从 Vite 开发服务器加载（带 hash 路由）：

```
主窗口:    http://localhost:3000
设置窗口:  http://localhost:3000#settings
插件窗口:  http://localhost:3000#plugins
```

### 生产模式

窗口从打包后的本地 HTML 文件加载（带 hash 路由）：

```
主窗口:    file://.../dist/index.html
设置窗口:  file://.../dist/index.html#settings
插件窗口:  file://.../dist/index.html#plugins
```

## 安全特性

### 1. 上下文隔离

```typescript
webPreferences: {
  contextIsolation: true,
  nodeIntegration: false,
}
```

### 2. 外部链接

```typescript
window.webContents.setWindowOpenHandler(({ url }) => {
  shell.openExternal(url);
  return { action: 'deny' };
});
```

### 3. 预加载脚本

```typescript
// src/preload/index.ts
contextBridge.exposeInMainWorld('electron', {
  invoke: (channel: string, ...args: any[]) => ipcRenderer.invoke(channel, ...args),
  on: (channel: string, callback: Function) => ipcRenderer.on(channel, callback as any),
  removeListener: (channel: string, callback: Function) => ipcRenderer.removeListener(channel, callback as any),
});
```

## 最佳实践

### 1. 单例模式
每个窗口类型只创建一个实例，避免重复创建。

### 2. 内存管理
窗口关闭时自动清理引用，防止内存泄漏。

### 3. 错误处理

```typescript
const window = windowManager.getWindow('settings');
if (window && !window.isDestroyed()) {
  window.focus();
}
```

### 4. 平台差异

```typescript
app.on('window-all-closed', () => {
  // Lumina 在所有平台默认托盘常驻，不直接退出
});
```

## 未来扩展

- 窗口状态持久化（位置/大小/状态）
- 多显示器支持与智能定位
- 显示/隐藏动画
- 主题与外观统一

## 相关文档

- `src/shared/utils/window.ts`：窗口 URL 与配置
- `src/main/windows/windowManager.ts`：窗口管理器实现
- `README.md`：总体说明

