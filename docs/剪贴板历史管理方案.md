# 剪贴板历史管理功能设计方案

## 📋 功能概述

实现一个智能的剪贴板历史管理系统，自动记录用户复制的内容，支持快速搜索、预览和粘贴历史项。

## 🎯 核心功能

### 1. 自动记录剪贴板
- 监听系统剪贴板变化
- 自动记录文本内容（支持纯文本、HTML、图片暂不考虑）
- 去重处理（相同内容不重复记录）
- 防抖机制（避免频繁写入）

### 2. 历史记录管理
- 记录最近 N 条（默认 50 条，可配置）
- 自动清理过期记录（默认保留 7 天）
- 支持手动删除单条记录
- 支持清空所有历史


### 4. 搜索与预览
- 在搜索框中输入 `clip` 或 `剪贴板` 触发
- 支持内容模糊搜索
- 显示内容预览（截断长文本）
- 显示复制时间
- 支持按时间排序

### 5. 快速粘贴
- 回车键快速粘贴选中项
- 支持快捷键操作
- 粘贴后自动隐藏窗口

## 🏗️ 架构设计

### 1. 数据存储

#### 数据库表结构（在现有 SQLite 中添加）

```sql
CREATE TABLE IF NOT EXISTS clipboard_history (
  id TEXT PRIMARY KEY,
  content TEXT NOT NULL,
  content_preview TEXT,  -- 预览文本（前100字符）
  content_type TEXT DEFAULT 'text',  -- text, html
  is_sensitive BOOLEAN DEFAULT 0,  -- 是否敏感信息
  copy_count INTEGER DEFAULT 1,  -- 复制次数（去重用）
  created_at TEXT NOT NULL,  -- ISO 8601 格式
  last_used_at TEXT,  -- 最后使用时间
  INDEX idx_created_at (created_at),
  INDEX idx_content_preview (content_preview)
);
```

#### 设置项（在 settingsService.ts 中添加）

```typescript
interface AppSettings {
  // ... 现有设置
  
  // 剪贴板设置
  clipboardEnabled: boolean;  // 是否启用剪贴板历史
  clipboardMaxItems: number;  // 最大记录数（默认 50）
  clipboardRetentionDays: number;  // 保留天数（默认 7）
  clipboardSensitiveMode: 'ignore' | 'mark' | 'encrypt';  // 敏感信息处理模式
}
```

### 2. 服务层设计

#### 新建服务：`clipboardService.ts`

```typescript
// src/main/services/clipboardService.ts

interface ClipboardItem {
  id: string;
  content: string;
  contentPreview: string;
  contentType: 'text' | 'html';
  isSensitive: boolean;
  copyCount: number;
  createdAt: string;
  lastUsedAt?: string;
}

class ClipboardService {
  private isEnabled: boolean = false;
  private clipboard: Electron.Clipboard;
  private lastContent: string = '';
  private debounceTimer: NodeJS.Timeout | null = null;
  private readonly DEBOUNCE_DELAY = 500; // 500ms 防抖
  
  // 初始化
  public initialize(): void {
    // 从设置加载配置
    // 启动监听
  }
  
  // 开始监听剪贴板
  public startWatching(): void {}
  
  // 停止监听
  public stopWatching(): void {}
  
  // 记录剪贴板内容
  private async recordClipboard(content: string): Promise<void> {}
  
  // 检测敏感信息
  private detectSensitive(content: string): boolean {}
  
  // 获取历史记录
  public async getHistory(limit?: number): Promise<ClipboardItem[]> {}
  
  // 搜索历史记录
  public async searchHistory(query: string, limit?: number): Promise<ClipboardItem[]> {}
  
  // 删除记录
  public async deleteItem(id: string): Promise<void> {}
  
  // 清空历史
  public async clearHistory(): Promise<void> {}
  
  // 自动清理过期记录
  private async cleanupExpired(): Promise<void> {}
}
```

### 3. IPC 通信

#### 在 `preload/index.ts` 中添加

```typescript
clipboard: {
  getHistory: (limit?: number) => Promise<ClipboardItem[]>;
  searchHistory: (query: string, limit?: number) => Promise<ClipboardItem[]>;
  deleteItem: (id: string) => Promise<void>;
  clearHistory: () => Promise<void>;
  pasteItem: (id: string) => Promise<void>;
}
```

#### 新建处理器：`clipboardHandlers.ts`

```typescript
// src/main/handlers/clipboardHandlers.ts
export function registerClipboardHandlers() {
  // 获取历史记录
  ipcMain.handle('clipboard-get-history', async (_event, limit?: number) => {
    return clipboardService.getHistory(limit);
  });
  
  // 搜索历史记录
  ipcMain.handle('clipboard-search', async (_event, query: string, limit?: number) => {
    return clipboardService.searchHistory(query, limit);
  });
  
  // 删除记录
  ipcMain.handle('clipboard-delete', async (_event, id: string) => {
    await clipboardService.deleteItem(id);
    return { success: true };
  });
  
  // 清空历史
  ipcMain.handle('clipboard-clear', async () => {
    await clipboardService.clearHistory();
    return { success: true };
  });
  
  // 粘贴指定项
  ipcMain.handle('clipboard-paste', async (_event, id: string) => {
    await clipboardService.pasteItem(id);
    return { success: true };
  });
}
```

### 4. UI 集成

#### 在搜索界面中集成

**触发关键词：**
- `clip` / `clipboard` / `剪贴板` / `cb` - 显示所有历史
- `clip 关键词` - 搜索历史记录

**结果显示：**
```
┌─────────────────────────────────────┐
│ 📋 复制内容预览（前50字符）...      │
│ 2024-01-15 14:30:25                 │
└─────────────────────────────────────┘
```

**操作：**
- Enter：粘贴选中项
- Cmd/Ctrl + Delete：删除当前项
- Cmd/Ctrl + Shift + Delete：清空所有历史

## 🔒 敏感信息检测规则

### 1. 密码检测
```typescript
// 检测规则：
- 包含关键词：password, pwd, passwd, secret, token
- 格式：8-128 个字符，包含字母和数字
- 示例：MyPassword123
```

### 2. 信用卡号检测
```typescript
// 使用 Luhn 算法验证
// 格式：16 位数字，可能包含空格或连字符
// 示例：4532-1234-5678-9010
```

### 3. 邮箱密码组合
```typescript
// 检测 "email:password" 格式
// 示例：user@example.com:MyPassword123
```

## ⚙️ 性能优化

### 1. 防抖机制
- 500ms 内多次复制相同内容，只记录一次
- 避免频繁写入数据库

### 2. 去重策略
- 相同内容不重复记录
- 更新 `copy_count` 和 `last_used_at`

### 3. 内存管理
- 限制内存中的记录数量（最多 100 条）
- 定期清理过期记录

### 4. 数据库优化
- 使用索引加速搜索
- 定期 VACUUM 优化数据库

## 📝 实现步骤

### Phase 1: 基础功能（MVP）
1. ✅ 创建数据库表结构
2. ✅ 实现 `clipboardService.ts`
3. ✅ 实现 IPC 处理器
4. ✅ 实现剪贴板监听
5. ✅ 基础 UI 集成（搜索触发）

### Phase 2: 增强功能
1. ✅ 敏感信息检测
2. ✅ 设置界面
3. ✅ 删除/清空功能
4. ✅ 自动清理过期记录

### Phase 3: 优化
1. ✅ 性能优化
2. ✅ UI/UX 优化
3. ✅ 错误处理
4. ✅ 日志记录

## 🎨 UI/UX 设计

### 搜索界面集成

**触发示例：**
- 输入 `clip` → 显示最近 10 条历史
- 输入 `clip 代码` → 搜索包含"代码"的历史记录

**结果项显示：**
```
┌─────────────────────────────────────────┐
│ 📋 function calculateSum(a, b) {       │
│    return a + b;                        │
│ }                                       │
│                                         │
│ 2024-01-15 14:30:25 · 复制 3 次        │
└─────────────────────────────────────────┘
```

**敏感信息标记：**
```
┌─────────────────────────────────────────┐
│ 🔒 •••••••••••••••••                   │
│                                         │
│ 2024-01-15 14:30:25 · 敏感信息         │
└─────────────────────────────────────────┘
```

## 🔧 配置选项

### 设置页面新增"剪贴板"标签

```
┌─────────────────────────────────────┐
│ 启用剪贴板历史                      │
│ ☑️ 开启后自动记录复制的内容          │
│                                     │
│ 最大记录数                          │
│ [50] 条（建议 20-100）              │
│                                     │
│ 保留时间                            │
│ [7] 天（建议 3-30）                  │
│                                     │
│ 敏感信息处理                        │
│ ○ 不记录                            │
│ ● 记录但标记                        │
│ ○ 加密存储                          │
└─────────────────────────────────────┘
```

## 📊 数据统计（可选）

- 记录总数
- 今日复制次数
- 最常用内容 Top 10
- 敏感信息数量

## 🚀 后续扩展

1. **图片支持**：记录剪贴板图片（Base64 存储）
2. **分类标签**：手动标记常用项
3. **同步功能**：跨设备同步（需要云服务）
4. **快捷键**：全局快捷键快速访问
5. **插件集成**：与其他功能联动

## ⚠️ 注意事项

1. **隐私保护**：所有数据本地存储，不上传云端
2. **性能影响**：监听剪贴板对性能影响很小
3. **权限问题**：某些系统可能需要权限
4. **兼容性**：确保跨平台兼容（macOS/Windows/Linux）

---

**总结**：这是一个高价值的功能，实施难度中等，可以显著提升用户体验。建议优先实现 MVP 版本，然后逐步增强。

