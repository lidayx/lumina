# 时间和时间转换功能设计

## 一、功能概述

在现有计算器服务基础上，新增时间和时间转换功能，支持：
1. **时间查询** - 显示当前时间、日期
2. **时间戳转换** - Unix 时间戳与日期互转
3. **时间计算** - 两个时间之间的差值计算
4. **日期格式化** - 多种日期格式输出
5. **时区转换** - 不同时区的时间转换

## 二、功能设计

### 1. 时间查询功能

#### 触发关键词
- `time` / `时间` / `现在几点` / `当前时间`
- `date` / `日期` / `今天` / `今天日期`
- `now` / `现在`

#### 功能实现
显示当前本地时间和日期，支持多种格式：
- 默认格式：`2024-01-15 14:30:45`
- 中文格式：`2024年1月15日 14:30:45`
- ISO 格式：`2024-01-15T14:30:45.123Z`
- 时间戳（秒）：`1705312245`
- 时间戳（毫秒）：`1705312245123`

#### 示例输入
```
time
时间
现在几点
date
日期
```

### 2. 时间戳转换功能

#### 触发模式
识别以下模式：
- `timestamp <数字>` - 将时间戳转换为日期
- `<数字> to date` / `<数字> 转日期` - 将时间戳转换为日期
- `<日期字符串> to timestamp` - 将日期转换为时间戳
- `<日期字符串> 转时间戳` - 将日期转换为时间戳

#### 功能实现
- **时间戳 → 日期**：
  - 自动识别秒级或毫秒级时间戳
  - 支持秒级：`1705312245`
  - 支持毫秒级：`1705312245123`
  - 输出格式：`2024-01-15 14:30:45`

- **日期 → 时间戳**：
  - 支持多种日期格式输入
  - `2024-01-15 14:30:45`
  - `2024/01/15 14:30:45`
  - `2024-01-15T14:30:45`
  - 输出时间戳（秒和毫秒）

#### 示例输入
```
timestamp 1705312245
1705312245 to date
1705312245123 转日期
2024-01-15 14:30:45 to timestamp
2024/01/15 14:30:45 转时间戳
```

### 3. 时间计算功能

#### 触发模式
- `<时间1> - <时间2>` - 计算时间差
- `<时间1> + <时长>` - 时间加法
- `<时间1> - <时长>` - 时间减法
- `between <时间1> and <时间2>` - 计算两个时间之间的差值

#### 功能实现
- **时间差计算**：
  - 支持日期格式：`2024-01-15 14:30:45`
  - 支持时间戳：`1705312245`
  - 输出：天数、小时数、分钟数、秒数

- **时间加减**：
  - 时长格式：`1d 2h 30m`（1天2小时30分钟）
  - 时长格式：`2 days 3 hours`（2天3小时）
  - 时长格式：`30分钟`（30分钟）

#### 示例输入
```
2024-01-15 14:30:45 - 2024-01-10 10:00:00
between 2024-01-15 and 2024-01-10
2024-01-15 14:30:45 + 2 days 3 hours
2024-01-15 14:30:45 - 30分钟
```

### 4. 日期格式化功能

#### 触发模式
- `format <日期> <格式>` - 格式化日期
- `<日期> format <格式>` - 格式化日期

#### 支持的格式
- `YYYY-MM-DD` - 2024-01-15
- `YYYY/MM/DD` - 2024/01/15
- `YYYY年MM月DD日` - 2024年01月15日
- `MM-DD-YYYY` - 01-15-2024
- `DD/MM/YYYY` - 15/01/2024
- `YYYY-MM-DD HH:mm:ss` - 2024-01-15 14:30:45
- `YYYY-MM-DD HH:mm` - 2024-01-15 14:30
- `ISO` - ISO 8601 格式
- `timestamp` - 时间戳

#### 示例输入
```
format 2024-01-15 YYYY年MM月DD日
2024-01-15 14:30:45 format ISO
timestamp 1705312245 format YYYY-MM-DD HH:mm:ss
```

### 5. 时区转换功能

#### 触发模式
- `<时间> to <时区>` - 转换时区
- `<时间> in <时区>` - 显示指定时区的时间
- `<时间> <时区1> to <时区2>` - 时区间转换

#### 支持的时区
- `UTC` / `GMT`
- `CST` / `China` / `中国`（UTC+8）
- `EST` / `Eastern`（UTC-5）
- `PST` / `Pacific`（UTC-8）
- `JST` / `Japan` / `日本`（UTC+9）
- `BST` / `London`（UTC+1）
- `CET` / `Europe`（UTC+1）
- 标准时区缩写：`UTC+8`, `UTC-5` 等

#### 示例输入
```
2024-01-15 14:30:45 to UTC
2024-01-15 14:30:45 CST to EST
now in JST
时间 to UTC+8
```

## 三、实现方案

### 1. 扩展计算器服务

在 `src/main/services/calculatorService.ts` 中添加时间相关方法：

```typescript
class CalculatorService {
  // 新增方法
  public handleTimeQuery(query: string): CalculationResult | null {
    // 检测时间查询类型并处理
  }
  
  private getCurrentTime(format?: string): string {
    // 获取当前时间
  }
  
  private convertTimestamp(timestamp: string): CalculationResult {
    // 时间戳转日期
  }
  
  private convertDateToTimestamp(dateStr: string): CalculationResult {
    // 日期转时间戳
  }
  
  private calculateTimeDifference(time1: string, time2: string): CalculationResult {
    // 计算时间差
  }
  
  private formatDate(dateStr: string, format: string): CalculationResult {
    // 格式化日期
  }
  
  private convertTimezone(timeStr: string, targetZone: string): CalculationResult {
    // 时区转换
  }
}
```

### 2. 修改 calculate 方法

在 `calculate` 方法中，在单位换算之前添加时间查询检测：

```typescript
public calculate(expression: string): CalculationResult {
  // ... 现有代码 ...
  
  // 新增：检测时间查询
  const timeResult = this.handleTimeQuery(expression);
  if (timeResult) {
    return timeResult;
  }
  
  // 现有的单位换算检测
  const unitConvertResult = this.tryUnitConversion(expression);
  // ...
}
```

### 3. 时间查询检测逻辑

```typescript
private handleTimeQuery(query: string): CalculationResult | null {
  const lowerQuery = query.toLowerCase().trim();
  
  // 1. 检测当前时间查询
  if (this.isTimeQuery(lowerQuery)) {
    return this.getCurrentTimeResult();
  }
  
  // 2. 检测时间戳转换
  if (this.isTimestampConversion(query)) {
    return this.convertTimestamp(query);
  }
  
  // 3. 检测日期转时间戳
  if (this.isDateToTimestamp(query)) {
    return this.convertDateToTimestamp(query);
  }
  
  // 4. 检测时间计算
  if (this.isTimeCalculation(query)) {
    return this.calculateTimeDifference(query);
  }
  
  // 5. 检测日期格式化
  if (this.isDateFormatting(query)) {
    return this.formatDate(query);
  }
  
  // 6. 检测时区转换
  if (this.isTimezoneConversion(query)) {
    return this.convertTimezone(query);
  }
  
  return null;
}
```

### 4. 正则表达式模式

```typescript
// 时间查询关键词
const TIME_QUERY_PATTERNS = [
  /^(time|时间|现在几点|当前时间|now)$/i,
  /^(date|日期|今天|今天日期)$/i,
];

// 时间戳转换
const TIMESTAMP_PATTERN = /^(timestamp|ts)\s+(\d{10,13})$/i;
const TO_DATE_PATTERN = /^(\d{10,13})\s+(?:to|转)\s+date$/i;

// 日期转时间戳
const DATE_TO_TIMESTAMP_PATTERN = /^(.+?)\s+(?:to|转)\s+timestamp$/i;

// 时间计算
const TIME_DIFF_PATTERN = /^(.+?)\s*-\s*(.+?)$/;
const TIME_BETWEEN_PATTERN = /^between\s+(.+?)\s+and\s+(.+?)$/i;
const TIME_ADD_PATTERN = /^(.+?)\s+\+\s+(.+?)$/;

// 日期格式化
const FORMAT_PATTERN = /^(?:format|格式化)\s+(.+?)\s+(.+?)$/i;
const FORMAT_REVERSE_PATTERN = /^(.+?)\s+(?:format|格式化)\s+(.+?)$/i;

// 时区转换
const TIMEZONE_PATTERN = /^(.+?)\s+(?:to|in|到)\s+(.+?)$/i;
```

## 四、实现步骤

### 步骤 1：扩展计算器服务类型定义
- 在 `CalculationResult` 中添加可选的 `timeData` 字段
- 支持时间相关的额外信息展示

### 步骤 2：实现时间查询功能
- 实现 `isTimeQuery()` 检测方法
- 实现 `getCurrentTimeResult()` 返回当前时间
- 支持多种时间格式输出

### 步骤 3：实现时间戳转换
- 实现 `convertTimestamp()` 方法
- 自动识别秒级/毫秒级时间戳
- 实现 `convertDateToTimestamp()` 方法
- 支持多种日期格式解析

### 步骤 4：实现时间计算
- 实现 `calculateTimeDifference()` 方法
- 支持时间差计算
- 支持时间加减运算
- 格式化输出（天数、小时、分钟、秒）

### 步骤 5：实现日期格式化
- 实现 `formatDate()` 方法
- 支持多种日期格式模板
- 解析日期字符串并转换为目标格式

### 步骤 6：实现时区转换
- 实现 `convertTimezone()` 方法
- 支持常用时区识别
- 支持 UTC 偏移量格式（如 UTC+8）

### 步骤 7：集成到搜索流程
- 在 `MainLayout.tsx` 中，时间查询结果会通过计算器服务自动显示
- 无需额外修改搜索逻辑，因为时间查询会返回 `CalculationResult` 格式

### 步骤 8：测试验证
- 测试各种时间查询场景
- 测试边界情况（无效时间戳、格式错误等）
- 测试跨时区转换准确性

## 五、使用示例

### 示例 1：查询当前时间
```
输入：time
输出：2024-01-15 14:30:45
描述：当前时间
```

### 示例 2：时间戳转换
```
输入：timestamp 1705312245
输出：2024-01-15 14:30:45
描述：时间戳 1705312245 对应的日期时间
```

### 示例 3：日期转时间戳
```
输入：2024-01-15 14:30:45 to timestamp
输出：1705312245 (秒)
      1705312245123 (毫秒)
描述：日期对应的时间戳
```

### 示例 4：时间差计算
```
输入：2024-01-15 14:30:45 - 2024-01-10 10:00:00
输出：5天 4小时 30分钟 45秒
描述：两个时间之间的差值
```

### 示例 5：时区转换
```
输入：2024-01-15 14:30:45 CST to EST
输出：2024-01-15 01:30:45 EST
描述：中国标准时间转换为美国东部时间
```

### 示例 6：日期格式化
```
输入：format 2024-01-15 YYYY年MM月DD日
输出：2024年01月15日
描述：格式化后的日期
```

## 六、技术要点

### 1. 日期解析
- 使用 JavaScript 的 `Date` 对象
- 支持多种日期格式的自动识别
- 处理时区和本地时间的转换

### 2. 时间戳处理
- 自动识别秒级（10位）和毫秒级（13位）时间戳
- 处理 Unix 时间戳（秒）和 JavaScript 时间戳（毫秒）

### 3. 时区转换
- 使用 `Intl.DateTimeFormat` 或手动计算时区偏移
- 支持常用时区的缩写识别
- 支持 UTC 偏移量格式

### 4. 日期格式化
- 实现自定义格式化函数
- 支持常见的日期格式模板
- 处理中英文格式

### 5. 错误处理
- 无效时间戳的处理
- 无法解析的日期格式
- 时区识别失败的处理

## 七、后续扩展

可以考虑添加：
1. **相对时间**：`3天前`、`2小时后`、`下周` 等
2. **工作日计算**：计算两个日期之间的工作日
3. **节假日识别**：识别中国节假日、国际节假日
4. **时间提醒**：设置时间提醒功能
5. **世界时钟**：同时显示多个时区的时间

---

**文档创建日期**：2024年
**功能状态**：设计阶段
**预计实现时间**：1-2天

