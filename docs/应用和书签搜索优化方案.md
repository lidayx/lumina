# åº”ç”¨å’Œä¹¦ç­¾æœç´¢ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“± åº”ç”¨æœç´¢ä¼˜åŒ–

### å½“å‰å®ç°åˆ†æ

**macOS:**
- âŒ éå† `/Applications` å’Œ `~/Applications` ç›®å½•ï¼ˆå…¨é‡æ‰«æï¼‰
- âœ… ä½¿ç”¨ `mdls` è·å–æ˜¾ç¤ºåç§°ï¼ˆæ”¯æŒæœ¬åœ°åŒ–ï¼‰
- âœ… è¯»å– `Info.plist` è·å–å›¾æ ‡

**Windows:**
- âŒ é€’å½’æ‰«æ `C:\Program Files` ç­‰ç›®å½•ï¼ˆæ·±åº¦ 3 çº§ï¼Œæ€§èƒ½å·®ï¼‰
- âŒ åªæ‰«æ `.exe`ï¼Œå¯èƒ½é—æ¼ UWP åº”ç”¨å’Œ Start Menu å¿«æ·æ–¹å¼

**Linux:**
- âœ… è¯»å– `.desktop` æ–‡ä»¶ï¼ˆç¬¦åˆè§„èŒƒï¼‰
- âš ï¸ ç¼ºå°‘å›¾æ ‡æ”¯æŒ

### ä¼˜åŒ–æ–¹æ¡ˆ

#### 1. macOS - ä½¿ç”¨ Spotlight ç´¢å¼•ï¼ˆæ¨è â­ï¼‰

**ä¼˜åŠ¿:**
- åˆ©ç”¨ç³»ç»Ÿç´¢å¼•ï¼Œé€Ÿåº¦å¿«ï¼ˆæ¯«ç§’çº§ï¼‰
- è‡ªåŠ¨æ’é™¤éšè—/ç³»ç»Ÿåº”ç”¨
- æ”¯æŒåº”ç”¨åç§°æœ¬åœ°åŒ–

**å®ç°:**
```typescript
// ä½¿ç”¨ mdfind æŸ¥è¯¢ Spotlight ç´¢å¼•
private async indexMacAppsWithSpotlight(): Promise<Map<string, AppInfo>> {
  const { execSync } = require('child_process');
  const appsMap = new Map<string, AppInfo>();
  
  try {
    // æŸ¥è¯¢æ‰€æœ‰åº”ç”¨åŒ…ï¼ˆkMDItemContentType == com.apple.application-bundleï¼‰
    const command = 'mdfind "kMDItemContentType==com.apple.application-bundle && kMDItemKind==Application"';
    const output = execSync(command, { encoding: 'utf-8', maxBuffer: 10 * 1024 * 1024 });
    const appPaths = output.trim().split('\n').filter(p => p);
    
    for (const appPath of appPaths) {
      // åªå¤„ç†æ ‡å‡†åº”ç”¨ç›®å½•ä¸­çš„åº”ç”¨ï¼ˆæ’é™¤ç³»ç»Ÿåº”ç”¨ï¼‰
      if (appPath.startsWith('/Applications/') || appPath.startsWith(process.env.HOME + '/Applications/')) {
        await this.addMacApp(appPath, path.basename(appPath, '.app'), appsMap);
      }
    }
  } catch (error) {
    console.error('Spotlight æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°ç›®å½•æ‰«æ:', error);
    // å›é€€åˆ°ç°æœ‰çš„ç›®å½•æ‰«ææ–¹æ¡ˆ
    await this.indexMacApps(appsMap);
  }
  
  return appsMap;
}
```

**æ€§èƒ½æå‡:** ä»ç§’çº§é™ä½åˆ°æ¯«ç§’çº§ï¼Œç‰¹åˆ«æ˜¯åº”ç”¨æ•°é‡å¤šæ—¶ä¼˜åŠ¿æ˜æ˜¾

---

#### 2. Windows - ä½¿ç”¨ Start Menu + PowerShellï¼ˆæ¨è â­ï¼‰

**ä¼˜åŠ¿:**
- Start Menu åªåŒ…å«ç”¨æˆ·å¯è§çš„åº”ç”¨
- PowerShell æŸ¥è¯¢é€Ÿåº¦å¿«
- æ”¯æŒ UWP åº”ç”¨å’Œä¼ ç»Ÿæ¡Œé¢åº”ç”¨

**å®ç°:**
```typescript
private async indexWindowsAppsFromStartMenu(): Promise<Map<string, AppInfo>> {
  const { execSync } = require('child_process');
  const appsMap = new Map<string, AppInfo>();
  
  const startMenuPaths = [
    path.join(process.env.APPDATA || '', 'Microsoft', 'Windows', 'Start Menu', 'Programs'),
    path.join(process.env.PROGRAMDATA || '', 'Microsoft', 'Windows', 'Start Menu', 'Programs'),
  ];
  
  for (const startMenuPath of startMenuPaths) {
    if (!fs.existsSync(startMenuPath)) continue;
    
    // ä½¿ç”¨ PowerShell é€’å½’æŸ¥æ‰¾ .lnk æ–‡ä»¶
    const psCommand = `
      Get-ChildItem -Path "${startMenuPath}" -Filter *.lnk -Recurse -ErrorAction SilentlyContinue | 
      ForEach-Object { 
        $shell = New-Object -ComObject WScript.Shell
        $shortcut = $shell.CreateShortcut($_.FullName)
        [PSCustomObject]@{
          Name = $_.BaseName
          Path = $shortcut.TargetPath
          Icon = $shortcut.IconLocation
        }
      } | ConvertTo-Json -Compress
    `;
    
    try {
      const output = execSync(
        `powershell -NoProfile -ExecutionPolicy Bypass -Command "${psCommand}"`,
        { encoding: 'utf-8', maxBuffer: 10 * 1024 * 1024 }
      );
      
      const shortcuts = JSON.parse(output);
      for (const shortcut of Array.isArray(shortcuts) ? shortcuts : [shortcuts]) {
        if (shortcut.Path && fs.existsSync(shortcut.Path)) {
          appsMap.set(`win-${shortcut.Name}`, {
            id: `win-${shortcut.Name}`,
            name: shortcut.Name,
            path: shortcut.Path,
            icon: shortcut.Icon,
            launchCount: 0,
            lastUsed: new Date(),
          });
        }
      }
    } catch (error) {
      console.error(`Start Menu æ‰«æå¤±è´¥ ${startMenuPath}:`, error);
    }
  }
  
  return appsMap;
}
```

**æ€§èƒ½æå‡:** ä»æ·±åº¦é€’å½’æ‰«æï¼ˆå¯èƒ½è€—æ—¶æ•°åˆ†é’Ÿï¼‰é™ä½åˆ°ç§’çº§

---

#### 3. Linux - å¢å¼º .desktop è§£æï¼ˆå°å¹…ä¼˜åŒ–ï¼‰

**æ”¹è¿›ç‚¹:**
- è§£æ `Icon` å­—æ®µï¼Œæ”¯æŒå›¾æ ‡è·¯å¾„
- å¤„ç† `Exec` å‚æ•°ï¼ˆ%f, %u ç­‰ï¼‰
- è¯»å– `Categories` ç”¨äºåˆ†ç±»

**å®ç°:**
```typescript
private async addLinuxApp(desktopPath: string, targetMap?: Map<string, AppInfo>): Promise<void> {
  try {
    const content = fs.readFileSync(desktopPath, 'utf-8');
    
    const parseDesktopFile = (content: string) => {
      const lines = content.split('\n');
      const result: Record<string, string> = {};
      
      for (const line of lines) {
        if (line.includes('=') && !line.startsWith('#')) {
          const [key, ...valueParts] = line.split('=');
          result[key.trim()] = valueParts.join('=').trim();
        }
      }
      
      return result;
    };
    
    const desktop = parseDesktopFile(content);
    
    // è·³è¿‡ NoDisplay=true æˆ– Hidden=true çš„åº”ç”¨
    if (desktop.NoDisplay === 'true' || desktop.Hidden === 'true') {
      return;
    }
    
    if (desktop.Name && desktop.Exec) {
      const appInfo: AppInfo = {
        id: `linux-${desktop.Name}`,
        name: desktop.Name,
        path: desktopPath,
        icon: desktop.Icon || undefined,
        launchCount: 0,
        lastUsed: new Date(),
      };
      
      const appsMap = targetMap || this.apps;
      appsMap.set(appInfo.id, appInfo);
    }
  } catch (error) {
    console.error(`âš ï¸ [åº”ç”¨æœåŠ¡] æ·»åŠ åº”ç”¨å¤±è´¥ ${desktopPath}:`, error);
  }
}
```

---

## ğŸ“š ä¹¦ç­¾æœç´¢ä¼˜åŒ–

### å½“å‰å®ç°åˆ†æ

**ä¼˜ç‚¹:**
- âœ… æ”¯æŒ Chrome/Edge/Operaï¼ˆJSON æ ¼å¼ï¼‰
- âœ… ä»æ•°æ®åº“ç¼“å­˜åŠ è½½ï¼ˆå¯åŠ¨å¿«ï¼‰
- âœ… æ”¯æŒå¤šæµè§ˆå™¨è·¯å¾„æ£€æµ‹

**ç¼ºç‚¹:**
- âŒ ä»…æ”¯æŒ Firefox HTML æ ¼å¼ï¼ˆå·²è¿‡æ—¶ï¼Œç°ä»£ Firefox ä½¿ç”¨ SQLiteï¼‰
- âŒ Safari plist æœªå®ç°
- âŒ æ— å¢é‡æ›´æ–°ï¼ˆå®šæ—¶å…¨é‡æ‰«æï¼‰
- âŒ æœªç›‘æ§ä¹¦ç­¾æ–‡ä»¶å˜åŒ–ï¼ˆéœ€è¦æ‰‹åŠ¨åˆ·æ–°ï¼‰

### ä¼˜åŒ–æ–¹æ¡ˆ

#### 1. Firefox - ä½¿ç”¨ SQLiteï¼ˆæ¨è â­ï¼‰

ç°ä»£ Firefox ä½¿ç”¨ `places.sqlite` æ•°æ®åº“å­˜å‚¨ä¹¦ç­¾ï¼Œæ€§èƒ½æ›´å¥½ï¼š

```typescript
private async readFirefoxBookmarksFromSQLite(profilePath: string): Promise<Bookmark[]> {
  const sqlite3 = require('sqlite3');
  const dbPath = path.join(profilePath, 'places.sqlite');
  
  if (!fs.existsSync(dbPath)) return [];
  
  return new Promise((resolve, reject) => {
    const db = new sqlite3.Database(dbPath, sqlite3.OPEN_READONLY, (err) => {
      if (err) {
        reject(err);
        return;
      }
      
      const query = `
        SELECT 
          b.id,
          b.title as name,
          p.url,
          b.dateAdded / 1000000 as dateAdded,
          h.last_visit_date / 1000 as dateLastUsed
        FROM moz_bookmarks b
        JOIN moz_places p ON b.fk = p.id
        LEFT JOIN moz_historyvisits h ON p.id = h.place_id
        WHERE b.type = 1 AND p.url IS NOT NULL
        ORDER BY b.dateAdded DESC
      `;
      
      db.all(query, [], (err, rows) => {
        if (err) {
          reject(err);
        } else {
          resolve(rows.map(row => ({
            id: `ff-${row.id}`,
            name: row.name || row.url,
            url: row.url,
            dateAdded: row.dateAdded ? Math.floor(row.dateAdded / 1000) : undefined,
            dateLastUsed: row.dateLastUsed ? Math.floor(row.dateLastUsed) : undefined,
          })));
        }
        db.close();
      });
    });
  });
}
```

**æ€§èƒ½æå‡:** ä» HTML è§£æï¼ˆæ…¢ä¸”è¿‡æ—¶ï¼‰åˆ° SQLite æŸ¥è¯¢ï¼ˆå¿«é€Ÿå‡†ç¡®ï¼‰

---

#### 2. Safari - å®ç° plist è§£æï¼ˆæ¨è â­ï¼‰

ä½¿ç”¨ Node.js çš„ `plist` åº“æˆ– macOS çš„ `plutil` å‘½ä»¤ï¼š

```typescript
private async readSafariBookmarks(bookmarkPath: string): Promise<Bookmark[]> {
  const { execSync } = require('child_process');
  
  try {
    // ä½¿ç”¨ plutil è½¬æ¢ä¸º JSON
    const command = `plutil -convert json -o - "${bookmarkPath}"`;
    const output = execSync(command, { encoding: 'utf-8' });
    const data = JSON.parse(output);
    
    const bookmarks: Bookmark[] = [];
    
    const traverse = (node: any) => {
      if (node.WebBookmarkType === 'WebBookmarkTypeLeaf' && node.URLString) {
        bookmarks.push({
          id: `safari-${node.WebBookmarkUUID || Date.now()}-${bookmarks.length}`,
          name: node.URIDictionary?.title?.string || node.URLString,
          url: node.URLString,
        });
      }
      
      if (node.Children) {
        node.Children.forEach((child: any) => traverse(child));
      }
    };
    
    if (data.Children) {
      data.Children.forEach((child: any) => traverse(child));
    }
    
    return bookmarks;
  } catch (error) {
    console.error('è¯»å– Safari ä¹¦ç­¾å¤±è´¥:', error);
    return [];
  }
}
```

---

#### 3. æ–‡ä»¶ç›‘æ§ - å¢é‡æ›´æ–°ï¼ˆæ¨è â­ï¼‰

ç›‘æ§å•ä¸ªä¹¦ç­¾æ–‡ä»¶å˜åŒ–ï¼Œé¿å…å®šæ—¶å…¨é‡æ‰«æï¼š

```typescript
private bookmarkWatcher: fs.FSWatcher | null = null;

private startBookmarkWatcher(bookmarkPath: string): void {
  if (this.bookmarkWatcher) {
    this.bookmarkWatcher.close();
  }
  
  this.bookmarkWatcher = fs.watch(bookmarkPath, (eventType) => {
    if (eventType === 'change') {
      console.log('ğŸ“š [ä¹¦ç­¾æœåŠ¡] æ£€æµ‹åˆ°ä¹¦ç­¾æ–‡ä»¶å˜åŒ–ï¼Œé‡æ–°åŠ è½½...');
      // é˜²æŠ–ï¼šå»¶è¿Ÿ 1 ç§’åé‡æ–°åŠ è½½ï¼ˆé¿å…é¢‘ç¹è§¦å‘ï¼‰
      setTimeout(async () => {
        await this.scanBookmarks(bookmarkPath);
      }, 1000);
    }
  });
  
  this.bookmarkWatcher.on('error', (error) => {
    console.error('ä¹¦ç­¾æ–‡ä»¶ç›‘æ§é”™è¯¯:', error);
  });
}

// åœ¨ loadBookmarks ä¸­è°ƒç”¨
public async loadBookmarks(): Promise<void> {
  // ... ç°æœ‰ä»£ç  ...
  
  if (this.bookmarkPath && fs.existsSync(this.bookmarkPath)) {
    // å¯åŠ¨æ–‡ä»¶ç›‘æ§
    this.startBookmarkWatcher(this.bookmarkPath);
  }
}
```

**ä¼˜åŠ¿:**
- å®æ—¶æ›´æ–°ä¹¦ç­¾ï¼ˆæ— éœ€ç­‰å¾…å®šæ—¶ä»»åŠ¡ï¼‰
- åªç›‘æ§å•ä¸ªæ–‡ä»¶ï¼ˆæ€§èƒ½å¼€é”€å°ï¼‰
- å‡å°‘ä¸å¿…è¦çš„å…¨é‡æ‰«æ

---

## ğŸ“Š ä¼˜åŒ–æ”¶ç›Šæ€»ç»“

| ä¼˜åŒ–é¡¹ | å½“å‰æ–¹æ¡ˆ | ä¼˜åŒ–æ–¹æ¡ˆ | æ€§èƒ½æå‡ | å®æ–½éš¾åº¦ |
|--------|---------|---------|---------|---------|
| macOS åº”ç”¨æœç´¢ | ç›®å½•éå† | Spotlight ç´¢å¼• | âš¡âš¡âš¡ ç§’çº§â†’æ¯«ç§’çº§ | â­â­ ä¸­ç­‰ |
| Windows åº”ç”¨æœç´¢ | é€’å½’æ‰«æ | Start Menu + PowerShell | âš¡âš¡âš¡ åˆ†é’Ÿçº§â†’ç§’çº§ | â­â­â­ è¾ƒéš¾ |
| Linux åº”ç”¨æœç´¢ | .desktop è§£æ | å¢å¼ºè§£æï¼ˆå›¾æ ‡ã€åˆ†ç±»ï¼‰ | âš¡ å°å¹…æå‡ | â­ ç®€å• |
| Firefox ä¹¦ç­¾ | HTML è§£æ | SQLite æŸ¥è¯¢ | âš¡âš¡ æ˜¾è‘—æå‡ | â­â­ ä¸­ç­‰ |
| Safari ä¹¦ç­¾ | æœªå®ç° | plist è§£æ | âš¡âš¡ æ–°åŠŸèƒ½ | â­â­ ä¸­ç­‰ |
| ä¹¦ç­¾å¢é‡æ›´æ–° | å®šæ—¶å…¨é‡æ‰«æ | æ–‡ä»¶ç›‘æ§ | âš¡âš¡ å®æ—¶æ›´æ–° | â­ ç®€å• |

---

## ğŸ¯ æ¨èå®æ–½ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§ï¼ˆå¿«é€Ÿè§æ•ˆï¼‰:**
   - âœ… ä¹¦ç­¾æ–‡ä»¶ç›‘æ§ï¼ˆç®€å•ï¼Œæ”¶ç›Šé«˜ï¼‰
   - âœ… macOS Spotlight åº”ç”¨æœç´¢ï¼ˆæ€§èƒ½æå‡æ˜¾è‘—ï¼‰

2. **ä¸­ä¼˜å…ˆçº§ï¼ˆåŠŸèƒ½å®Œå–„ï¼‰:**
   - âœ… Firefox SQLite ä¹¦ç­¾æ”¯æŒ
   - âœ… Safari plist ä¹¦ç­¾æ”¯æŒ

3. **ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰:**
   - âš ï¸ Windows Start Menu ä¼˜åŒ–ï¼ˆéœ€ PowerShellï¼Œå¤æ‚åº¦é«˜ï¼‰
   - âš ï¸ Linux å›¾æ ‡æ”¯æŒï¼ˆç”¨æˆ·ä½“éªŒæå‡æœ‰é™ï¼‰

---

## ğŸ’¡ å®æ–½å»ºè®®

1. **ä¿æŒå‘åå…¼å®¹:** æ–°æ–¹æ¡ˆå¤±è´¥æ—¶å›é€€åˆ°ç°æœ‰æ–¹æ¡ˆ
2. **æ¸è¿›å¼ä¼˜åŒ–:** å…ˆå®æ–½é«˜ä¼˜å…ˆçº§é¡¹ï¼Œè§‚å¯Ÿæ•ˆæœåå†ç»§ç»­
3. **æ€§èƒ½ç›‘æ§:** è®°å½•ç´¢å¼•è€—æ—¶ï¼Œå¯¹æ¯”ä¼˜åŒ–å‰åæ•ˆæœ
4. **ç”¨æˆ·é…ç½®:** å¯è€ƒè™‘è®©ç”¨æˆ·é€‰æ‹©ä½¿ç”¨æ–°æ–¹æ¡ˆæˆ–æ—§æ–¹æ¡ˆï¼ˆè®¾ç½®é¡¹ï¼‰

